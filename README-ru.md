# НАБОР СКРИПТОВ ДЛЯ АВТОМАТИЗАЦИИ СОЛНЕЧНОЙ ЭЛЕКТРОСТАНЦИИ
### Подразумевается набор компонентов:
1. Инвертор MUST PV1800-5048VHM
2. JKBMS PB2A17S-20P
3. Миникомпьютер для скриптов, с двумя адаптерами USB-RS485, рядом с инвертором. В моем случае используется ASUS TinkerBoard 1.2 + Armbian.
4. Миникомпьютер или VM c Home-Assisant + MQTT + InfluxDB + Grafana. Рекомендую малинку с 64-битной OS.
5. Солнечные панели и батарея LiFePo4 на 48В


### Имеющиеся скрипты имеют следующий функционал:
1. Дампер данных и контроллер *jkbms_ctrl.py* - использует пулинг из нескольких запросов, для усреднения показаний.
2. Дампер данных и контроллер *pv1800_ctrl.py*
3. Монитор *batmon.php* - проверяет состояние батареи, делится сообщениями через удаленный бот Telegram, переключает инвертор из/в режим OFFGrid. 
4. Транслятор *mqtt-client.php* - передает состояние инвертора и BMS на сервер MQTT. 
5. Веб-страница мониторинга *index.php*, просто забросить в /var/www/html


### Порядок установки на миникомпьютер с Linux
1. Программы: `apt -y install apache2 php php-curl libapache2-mod-php pyton3 python3-pip`
2. Модули внутри venv: `pip3 install pyserial minimalmodbus pymodbus`
3. Скрипты `/mqtt`  поместить в `/root`,  `/sbin` в `/usr/local/sbin/` или `/usr/sbin/`, `/html` соответственно в `/var/www/html`
4. Установить мои библиотечные скрипты из репозитория alpet-libs в `/usr/share/php/lib`
5. Повредить безопасность в `/etc/systemd/system/multi-user.target.wants/apache2.service` указав *PrivateTmp=false*, при желании использовать веб-мониторинг (вся статистика сохраняется в /tmp)
6. Настроить расписание  `crontab -e`, для *backup_stats.sh* можно раз в сутки, дамперы и прочие php скрипты с интервалом 1-5 минут


### Логика жадной эксплуатации

В моем хозяйстве пока нагрузка довольно стабильная от компьютеров, порядка 600-900Вт круглосуточно. Солнце позволяет генерировать до 1300Вт в потолке, несколько часов в день. Инвертор с кривой прошивкой после заряда батареи перестает использовать солнечные панели практически полностью, что меня не устраивает. Поэтому цикл такой: после выхода генерации на перекрывающую мощность и минимальный заряд батареи, инвертор программно отключается от розетки (это не документировано в Modbus протоколе инвертора, однако работает). Далее типично нагрузка висит на солнце, а избыток поступает в батарею и заряжает её за несколько часов. По мере захода солнца нагрузка начинает разряжать батарею, и в момент серьёзного разряда происходит обратное подключения инвертора к сети. В своем инверторе я запрограммировал ограниченный ток заряда от сети, чтобы не расходовать дорогое электричество, порядка 2А - это возвращает несколько % заряда до восхода солнца.

### Баг-фишка
Инвертор хоть и не является моделью ONGrid, продавать электричество в сеть умеет... неизвестно насколько безопасно. Чтобы это сработало, надо в BMS выключить зарядный MOSFET, и определить предел отдаваемого тока *"Inverter max discharger current" 20113* - это можно сделать записав в `/root/inverter_cmd.lst` команду `20113=50` (не более 5А). Поскольку прошивка не адаптирована под такой режим, возвращать в протоколе Modbus инвертор будет нулевую мощность PGrid 25214 (подозреваю использование кода вроде `power = min(power, 0)`), соответственно мой скрипт высчитает мощность исходя из активной и реактивной. Тем не менее показатели вроде *Accumulated sell power* начинают расти в таком режиме, а общий ток в квартиру у меня уменьшается, т.к. инвертор установлен как автономное, а не промежуточное звено между щитом и вводом.